---
title: "Übersicht über bisherige Ergebnisse"
author: "Julia Hoepler"
date: "17 11 2019"
output: pdf_document
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)
require(ggplot2)
require(ggmap)
```

```{r zeitliche Verteilung(Publicity-Aktionen und Eintraege), echo=FALSE}
plt_publicity <- function(df, days, year, size = 2) {
  plt <- ggplot(df, aes(x = days, y = freq)) +
    geom_bar(stat = "identity", col = "black") +
    ylim(0, 600) +
    theme_bw() + 
    theme(axis.text = element_text(size = 18, face = "bold"),
          axis.title = element_text(size = 18, face = "bold")) +
    xlab(year) +
    ylab("Anzahl Eintraege in Datenbank")
  # constructing values for geom_segment
  values <- numeric(length = length(days))
  for (i in seq_along(days)) {
    tmp <- df$freq[df$days == as.Date(days[i])]
    values[i] <- if (length(tmp) == 0) {
      0
    } else {tmp}
  }
  segment_data = data.frame(
    x = as.Date(days),
    xend = as.Date(days), 
    y = values,
    yend = rep(600, times = length(days))
  )
  # adding the segments to the plot
  plt <- plt + geom_segment(data = segment_data, 
                            aes(x = x, y = y, xend = xend, yend = yend), 
                            col = "#ff8000", alpha = 0.75, size = size)
  plt
}
df2017 <- readRDS("df2017.RDS")
df2018 <- readRDS("df2018.RDS")
df2019 <- readRDS("df2019.RDS")
pubdays2017 <- readRDS("pubdays2017.RDS")
pubdays2018 <- readRDS("pubdays2018.RDS")
pubdays2019 <- readRDS("pubdays2019.RDS")
plt_publicity(df2017, pubdays2017, "2017", size = 1.4)
plt_publicity(df2018, pubdays2018, "2018", size = 1.4)
plt_publicity(df2019, pubdays2019, "2019", size = 1.4)
```

```{r spatial, echo=TRUE}
sp_crowd <- readRDS("sp_crowd.RDS")
box <- sp_crowd@bbox
box[2,] <- c(44, 49)
df <- readRDS("lastone.RDS")
map <- get_stamenmap(bbox = box, zoom = 7, maptype = "toner") 
plt <- ggmap(map) +
  geom_point(aes(x = lng, y = lat, size = sqrt(Freq), col = sqrt(Freq)),
             data = df, alpha = .5)
plt
# Räumliche Verteilung der Einträge in die Datenbank
plt2 <- ggmap(map) +
  stat_density2d(aes(x = lng, y = lat),
  col = "blue", fill = "blue", alpha = 0.1, size = 1, bins = 10, data = df, geom = "polygon"
) 
plt2
# 2D Dichteplot der Verteilung der Einträge in die Datenbank
uniquepoints <- readRDS("uniquepoints.RDS")
plt3 <- plt2 +
  geom_point(aes(x = lng, y = lat, size = count), data = uniquepoints, col = "red")
plt3
# Lokationen der 10 "Poweruser"; Also der 10 Benutzer welche die meisten Beiträge
# zur Datenbank hinzufügten.
```

```{r raeumliche Verteilung von Belege durch Crowdsourcing}
require(sf)
require(raster)
require(sp)
require(mapview)
crowd01 <- read.csv("~/statprakt/crowd01.csv", encoding = "UTF-8", sep = ",")
coords <- crowd01$Georeferenz
coords <- as.character(coords)

geo <- sub("POINT", "", coords)
geo <- sub("\\(", "", geo)
geo <- sub("\\)", "", geo)

list2 <- stringr::str_split(geo, " ")
one <- sapply(list2, `[[`, 1)
two <- sapply(list2, `[[`, 2)

Breite_crowd01 <- two
Laenge_crowd01 <- one

Breite_crowd01 <- as.numeric(Breite_crowd01)

Laenge_crowd01 <- as.numeric(Laenge_crowd01)

## Kenngrößen 
mean(Breite_crowd01)
#47.18558
mean(Laenge_crowd01)
#11.11622
#Mittelpunkt(11.11622 47.18558)

##Streuung
var(Breite_crowd01)
#0.970931
var(Laenge_crowd01)
#3.41473

sd(Breite_crowd01)
#0.9853583
sd(Laenge_crowd01)
#1.847899

range(Breite_crowd01)
#37.67845 50.38567
range(Laenge_crowd01)
#5.397995 16.268321

## Kenngrößen Zusammenfassung
summary(Laenge_crowd01)
# Min. 1st Qu.  Median    Mean 3rd Qu.    Max. 
#5.398   9.870  11.618  11.116  12.313  16.268 

summary(Breite_crowd01)
# Min. 1st Qu.  Median    Mean 3rd Qu.    Max. 
#37.68   46.47   47.15   47.19   47.84   50.39 
```

```{r Crowd map}

```

```{r Hauptkategorie, echo=FALSE}
library(ggplot2)

# Entferne Duplikate, im einen Überblick über die Hauptkategorien zu erlangen
Hauptkategorie2 <- unique(crowd01$Hauptkategorie)

#[1] Milchverarbeitung      Viehhaltung            Holzverarbeitung      
#[4] Allgemein              Backen                 Ackerbau              
#[7] Fauna                  Flora                  Küche                 
#[10] Zeit                   Landschaftsformationen Wetter                
#12 Levels: Ackerbau Allgemein Backen Fauna Flora Holzverarbeitung ... Zeit

#absolute Haeufigkeiten der zwölf Hauptkategorien
table(crowd01$Hauptkategorie)

#Ackerbau              Allgemein                 Backen 
#389                   2047                    412 
#Fauna                  Flora       Holzverarbeitung 
#711                    728                    296 
#Küche Landschaftsformationen      Milchverarbeitung 
#274                    154                   4877 
#Viehhaltung                 Wetter                   Zeit 
#3724                    356                    129 

#Erstelle Barplot von den abs. Haeufigkeiten der Belege je Hauptkategorie
 
library("reshape2")

test2 <- melt(crowd01$Hauptkategorie)

mlt <- melt(table(test2))

mlt$test2 <- as.character(mlt$test2)
which(mlt$test2 == "Milchverarbeitung")
mlt$test2[9] <- "Milchv."

which(mlt$test2 == "Holzverarbeitung")
mlt$test2[6] <- "Holzv."

which(mlt$test2 == "Landschaftsformationen")
mlt$test2[8] <- "Landf."

ggplot(mlt, aes(reorder(x = test2, - value), y = value)) + 
  geom_bar(stat = "identity", fill = "brown1") + 
  geom_text(aes(label = value), vjust = 0) +
  theme(axis.text.x = element_text(angle = 45, hjust = 1)) + labs(x = "") + 
  ggtitle("Anzahl der Eintraege je Hauptkategorie") + theme(plot.title = element_text(hjust = 0.5))

mlt$relativ <- mlt$value/sum(mlt$value)
mlt$relativ <- round(mlt$relativ, digits = 2)

ggplot(mlt, aes(reorder(x = test2, - mlt$relativ), y = mlt$relativ)) + 
  geom_bar(stat = "identity", fill = "brown1") + 
  geom_text(aes(label = mlt$relativ), vjust = -0.5) +
  theme(axis.text.x = element_text(angle = 45, hjust = 1)) + labs(x = "", y = "rel. Haeufigkeit") + 
  ggtitle("Anteil der Eintraege je Hauptkategorie") + theme(plot.title = element_text(hjust = 0.5))

#"Milchv." = Milchverarbeitung
#"Holzv." = "Holzverarbeitung" 
#"Landf." = Landschaftsformationen
```

```{r Kategorie, echo=FALSE}
library(reshape2)
#Plot über absolute Haeufigkeiten
test2 <- melt(crowd01$Kategorie)
plot_Kategorie <- melt(table(test2))
ggplot(plot_Kategorie,aes(reorder(x = test2, -value), y = value)) + 
  geom_bar(stat = "identity", fill = "brown1", color = "black", alpha = 0.85) + 
  geom_text(aes(label = value), vjust = -0.5) +
  theme(axis.text.x = element_text(angle = 45, hjust = 1)) +
  labs(x = "") + 
  ggtitle ("Anzahl der Eintraege je Kategorie") +
  theme(plot.title = element_text(hjust = 0.5))


#relativen Haeufigkeiten berechnet
mlt$relative <- mlt$value/(sum(mlt$value))
mlt$relative <- round(mlt$relative, digits = 3)
head(mlt$relative)
#Plot mit relativen Haefigkeiten erstellen
test2 <- melt(crowd01$Kategorie)
plot_relative <- melt(table(test2))
plot_relative$relative <- round(plot_relative$value/(sum(plot_relative$value)), digits = 3)

ggplot(plot_relative,aes(reorder(x = test2, -plot_relative$relative),
                         y = plot_relative$relative)) + 
  geom_bar(stat = "identity", fill = "brown1", color = "black", alpha = 0.85) + 
  geom_text(aes(label = plot_relative$relative), vjust = -0.5) +
  theme(axis.text.x = element_text(angle = 45, hjust = 1)) +
  labs(x = "", y = "rel. Haeufigkeit") + 
  ggtitle ("Anteil der Eintraege je Kategorie") +
  theme(plot.title = element_text(hjust = 0.5))


```